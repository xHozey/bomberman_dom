<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bomber Game Client</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
        }

        #auth-screen,
        #lobby-screen,
        #game-screen {
            display: none;
            text-align: center;
        }

        #auth-screen.active,
        #lobby-screen.active,
        #game-screen.active {
            display: block;
        }

        #nickname-input {
            padding: 10px;
            font-size: 16px;
            margin: 10px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        #lobby-players {
            margin: 20px 0;
        }

        #lobby-players div {
            padding: 5px;
        }

        #chat-box {
            width: 300px;
            height: 100px;
            border: 1px solid #ccc;
            overflow-y: scroll;
            margin: 10px auto;
            padding: 5px;
        }

        #game-map {
            display: grid;
            grid-template-columns: repeat(23, 30px);
            gap: 1px;
            background-color: #ccc;
            width: fit-content;
            margin: 10px auto;
        }

        .tile {
            width: 30px;
            height: 30px;
            position: relative;
        }

        .wall {
            background-color: gray;
        }

        .soft-wall {
            background-color: brown;
        }

        .powerup {
            background-color: green;
        }

        .bomb {
            background-color: black;
        }

        .explosion {
            background-color: orange;
        }

        .free {
            background-color: lightgray;
        }

        .player {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            position: absolute;
            top: 5px;
            left: 5px;
        }

        .player-me {
            background-color: blue;
        }

        .player-other {
            background-color: red;
        }

        .nickname {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: black;
        }
    </style>
</head>

<body>
    <!-- Authentication Screen -->
    <div id="auth-screen" class="active">
        <h1>Enter Nickname</h1>
        <input type="text" id="nickname-input" maxlength="20" placeholder="Your nickname">
        <br>
        <button onclick="joinGame()">Join Game</button>
        <p id="auth-error" style="color: red;"></p>
    </div>

    <!-- Lobby Screen -->
    <div id="lobby-screen">
        <h1>Lobby</h1>
        <h3>Room ID: <span id="room-id"></span></h3>
        <h3>Level: <span id="room-level"></span></h3>
        <h3>Status: <span id="room-status"></span></h3>
        <div id="lobby-players"></div>
        <div id="chat-box"></div>
        <input type="text" id="chat-input" placeholder="Type a message..." onkeypress="handleChatInput(event)">
        <br>
        <button onclick="sendChatMessage()">Send</button>
    </div>

    <!-- Game Screen -->
    <div id="game-screen">
        <h1>Bomber Game</h1>
        <div id="game-map"></div>
        <div id="chat-box"></div>
        <input type="text" id="chat-input" placeholder="Type a message..." onkeypress="handleChatInput(event)">
        <br>
        <button onclick="sendChatMessage()">Send</button>
    </div>

    <script>
        const socket = new WebSocket('ws://localhost:8080'); // Adjust to your server address
        const tileSize = 30;
        let gameState = null;
        let myId = null;

        // Expected message types (aligned with SOCKET_TYPES)
        const MESSAGE_TYPES = {
            Error: 'error',
            Auth: 'authentification',
            Lobby: 'lobby',
            PlayerAction: 'player_action',
            GameStart: 'start',
            Msg: 'message',
            GameUpdate: 'update',
            GameEnd: 'GameEnd',
            RoomClosed: 'RoomClosed'
        };

        // Screen management
        const screens = {
            auth: document.getElementById('auth-screen'),
            lobby: document.getElementById('lobby-screen'),
            game: document.getElementById('game-screen')
        };

        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenName].classList.add('active');
        }

        // Authentication
        function joinGame() {
            const nickname = document.getElementById('nickname-input').value.trim();
            if (nickname.length === 0 || nickname.length > 20) {
                document.getElementById('auth-error').textContent = 'Nickname must be 1-20 characters';
                return;
            }
            socket.send(JSON.stringify({
                type: MESSAGE_TYPES.Auth,
                nickname: nickname
            }));
        }

        // Lobby rendering
        function updateLobby(data) {
            document.getElementById('room-id').textContent = data.roomId;
            document.getElementById('room-level').textContent = data.level;
            document.getElementById('room-status').textContent = data.state;
            const playersDiv = document.getElementById('lobby-players');
            playersDiv.innerHTML = '';
            data.players.forEach(player => {
                const div = document.createElement('div');
                div.textContent = `Player: ${player.nickname} (Character: ${player.character})`;
                playersDiv.appendChild(div);
            });
        }

        // Chat handling
        function handleChatInput(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            if (input.value.trim()) {
                socket.send(JSON.stringify({
                    type: MESSAGE_TYPES.Msg,
                    payload: input.value.trim()
                }));
                input.value = '';
            }
        }

        function addChatMessage(message) {
            const chatBox = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.textContent = message;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Game rendering
        function renderMap(map) {
            const gameMap = document.getElementById('game-map');
            gameMap.innerHTML = '';
            for (let y = 0; y < map.length; y++) {
                for (let x = 0; x < map[y].length; x++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile ' + getTileClass(map[y][x]);
                    tile.dataset.x = x;
                    tile.dataset.y = y;
                    gameMap.appendChild(tile);
                }
            }
        }

        function renderPlayers(players) {
            console.log('Rendering players:', players);
            const tiles = document.querySelectorAll('.tile');
            tiles.forEach(tile => {
                const existingPlayer = tile.querySelector('.player');
                if (existingPlayer) existingPlayer.remove();
                const existingNickname = tile.querySelector('.nickname');
                if (existingNickname) existingNickname.remove();
            });

            players.forEach(player => {
                if (player.isAlive && typeof player.x === 'number' && typeof player.y === 'number') {
                    const x = Math.round(Math.max(0, Math.min(22, player.x)));
                    const y = Math.round(Math.max(0, Math.min(10, player.y)));
                    const tile = document.querySelector(`.tile[data-x="${x}"][data-y="${y}"]`);
                    if (tile) {
                        const playerDiv = document.createElement('div');
                        playerDiv.className = 'player ' + (player.id === myId ? 'player-me' : 'player-other');
                        tile.appendChild(playerDiv);

                        const nicknameDiv = document.createElement('div');
                        nicknameDiv.className = 'nickname';
                        nicknameDiv.textContent = player.nickname;
                        tile.appendChild(nicknameDiv);
                    } else {
                        console.warn(`No tile found for player ${player.nickname} at (${x}, ${y})`);
                    }
                } else {
                    console.warn(`Invalid player data for ${player.nickname}:`, {
                        isAlive: player.isAlive,
                        x: player.x,
                        y: player.y
                    });
                }
            });
        }

        function getTileClass(tile) {
            switch (tile) {
                case 1: return 'wall';
                case 2: return 'soft-wall';
                case 3: return 'powerup';
                case 4: return 'bomb';
                case 5: return 'explosion';
                case 'x': return 'free';
                default: return 'free';
            }
        }

        // Input handling
        const keys = {};
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            sendPlayerAction();
        });
        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
            sendPlayerAction();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ') {
                socket.send(JSON.stringify({
                    type: MESSAGE_TYPES.PlayerAction,
                    payload: { action: 'placeBomb' }
                }));
            }
        });

        function sendPlayerAction() {
            let direction = null;
            if (keys['ArrowUp']) direction = 'up';
            else if (keys['ArrowDown']) direction = 'down';
            else if (keys['ArrowLeft']) direction = 'left';
            else if (keys['ArrowRight']) direction = 'right';

            socket.send(JSON.stringify({
                type: MESSAGE_TYPES.PlayerAction,
                payload: {
                    action: 'movement',
                    direction: direction,
                    isMoving: !!direction
                }
            }));
        }

        // WebSocket handling
        socket.onopen = () => {
            console.log('Connected to server');
        };

        socket.onmessage = async (event) => {
            try {




                // Check if message is valid JSON
                let data;
                try {
                    data = JSON.parse(event.data);
                } catch (parseErr) {
                    console.error('Failed to parse JSON:', parseErr, 'Raw message:', messageData);
                    return;
                }

                console.log('Parsed data:', data);

                // Validate message type
                if (!data.type) {
                    console.warn('Message missing type:', data);
                    return;
                }

                if (!Object.values(MESSAGE_TYPES).includes(data.type)) {
                    console.warn('Unrecognized message type:', data.type, 'Data:', data);
                    return;
                }

                switch (data.type) {
                    case MESSAGE_TYPES.Auth:
                        showScreen('auth');
                        break;
                    case MESSAGE_TYPES.Error:
                        if (screens.auth.classList.contains('active')) {
                            document.getElementById('auth-error').textContent = data.error;
                        }
                        break;
                    case MESSAGE_TYPES.Lobby:
                        showScreen('lobby');
                        updateLobby(data);
                        break;
                    case MESSAGE_TYPES.GameStart:
                        console.log('GameStart received:', data);
                        showScreen('game');
                        gameState = data;
                        myId = data.players.find(p => p.nickname === document.getElementById('nickname-input').value)?.id || null;
                        console.log('myId set to:', myId);
                        renderMap(data.map);
                        renderPlayers(data.players);
                        break;
                    case MESSAGE_TYPES.GameUpdate:
                        console.log('GameUpdate received:', data);
                        gameState = data;
                        renderMap(data.map);
                        renderPlayers(data.players);
                        break;
                    case MESSAGE_TYPES.GameEnd:
                        alert(`Game Over! Winner: ${data.winner ? data.winner.nickname : 'None'}`);
                        showScreen('auth');
                        break;
                    case MESSAGE_TYPES.RoomClosed:
                        alert('Room has been closed');
                        showScreen('auth');
                        break;
                    case MESSAGE_TYPES.Msg:
                        addChatMessage(data.payload);
                        break;
                    default:
                        console.warn('Unhandled message type:', data.type);
                }
            } catch (err) {
                console.error('Error processing message:', err, 'Raw data:', event.data);
            }
        };

        socket.onclose = () => {
            alert('Disconnected from server');
            showScreen('auth');
        };
    </script>
</body>

</html>